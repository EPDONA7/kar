<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VibeStream Studio Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --primary: #c084fc;
            --accent: #2dd4bf;
            --glass: rgba(0, 0, 0, 0.9);
            --border: rgba(255, 255, 255, 0.15);
        }
        #lyricsArea:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(255,255,255,0.1);
    box-shadow: 0 0 10px rgba(192, 132, 252, 0.2);
}
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            color: white;
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1e1b4b, #000000);
        }

        .studio-container { width: 95%; max-width: 500px; padding: 20px 0; }
        .panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
        }

        h1 { text-align: center; margin: 0 0 20px 0; font-weight: 900; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        
        .file-upload {
            border: 2px dashed var(--border);
            padding: 15px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        input[type="text"] {
            background: rgba(255,255,255,0.1); border: 1px solid var(--border);
            padding: 12px; border-radius: 10px; color: white; outline: none; width: 100%; box-sizing: border-box;
        }

        .video-wrapper {
            width: 100%; padding-bottom: 56.25%; background: #000; border-radius: 15px;
            position: relative; overflow: hidden; border: 1px solid var(--border); margin-bottom: 15px;
        }
        #yt-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .mixer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .fader label { display: block; font-size: 0.7rem; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
        input[type="range"] { width: 100%; accent-color: var(--primary); }

        .action-btn {
            width: 100%; padding: 18px; border-radius: 15px; border: none; 
            font-size: 1rem; font-weight: 800; cursor: pointer; transition: 0.2s;
            margin-top: 10px; text-transform: uppercase;
        }

        #btnRecord { background: var(--primary); color: #000; }
        #btnRecord.recording { background: #ff4757; animation: pulse 1s infinite; color: white; }
        
        .download-group { display: none; margin-top: 15px; gap: 10px; }
        #btnShare { background: #3b82f6; color: white; flex: 1; }
        #btnTikTok { background: white; color: black; flex: 1; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        #videoModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        canvas { width: 100%; max-height: 70vh; object-fit: contain; }
    </style>
</head>
<body>

<div class="studio-container">
    <div class="panel">
        <h1>EPDONA</h1>
        
        <div class="input-group">
            <div class="file-upload" onclick="document.getElementById('beatInput').click()">
                <input type="file" id="beatInput" accept="audio/*" style="display:none">
                <span id="file-label">üìÇ Tap to Load Local Beat</span>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="ytUrl" placeholder="Paste YouTube Link...">
                <button onclick="loadVideo()" style="padding:0 15px; border-radius:10px; border:none; background:var(--accent); color:black; font-weight:bold;">GO</button>
            </div>
        </div>

        <div class="video-wrapper">
            <div id="yt-player"></div>
        </div>
<div class="lyrics-container" style="margin-top: 15px;">
    <label style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase;">üìù Lyrics / Notes</label>
    <textarea id="lyricsArea" placeholder="Write your lyrics here..." 
        style="width: 100%; height: 80px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
        border-radius: 10px; color: white; padding: 10px; margin-top: 5px; resize: none; font-family: inherit;"></textarea>
</div>
        <div class="mixer-controls">
            <div class="fader">
                <label>Beat Boost</label>
                <input type="range" id="beatSlider" min="0" max="1.5" step="0.05" value="0.8" oninput="updateMix()">
            </div>
            <div class="fader">
                <label>Voice Gain</label>
                <input type="range" id="voiceSlider" min="0" max="3" step="0.1" value="1.5" oninput="updateMix()">
            </div>
        </div>

        <button id="btnRecord" class="action-btn" onclick="toggleRecording()">‚óè START RECORDING</button>
        <div id="status" style="text-align:center; font-size:0.8rem; margin-top:10px; color:var(--accent);">Ready</div>

        <audio id="masterAudio" controls style="width:100%; margin-top:15px; display:none;"></audio>
        
        <div class="download-group" id="downloadGroup">
            <button id="btnShare" class="action-btn" onclick="shareAudio()">üì§ Save to iPhone</button>
            <button id="btnTikTok" class="action-btn" onclick="openVideoBooth()">üì± Make Video</button>
        </div>
    </div>
</div>

<div id="videoModal">
    <canvas id="videoCanvas" width="720" height="1280"></canvas>
    <div style="padding: 20px; width: 100%; box-sizing: border-box;">
        <button id="btnCamRecord" class="action-btn" onclick="startVideoRecording()" style="background:#ff4757; color:white;">‚óè RECORD VIDEO</button>
        <button class="action-btn" onclick="closeVideoBooth()" style="background:#333; color:white;">EXIT</button>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let player, mic, recorder, beatPlayer, masterGain, limiter, streamDestination;
    let isRecording = false;
    let audioBlob = null;
    let useYouTube = false;

    // --- 1. YOUTUBE API ---
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', { 
            height: '100%', width: '100%', 
            playerVars: { 'controls': 1, 'rel': 0, 'modestbranding': 1 } 
        });
    }

    function loadVideo() {
    let url = document.getElementById('ytUrl').value;
    let id = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11}).*/);
    if(id) { 
        // "cue" prepares the video but stays paused
        player.cueVideoById(id[1]); 
        useYouTube = true;
        document.getElementById('status').innerText = "YouTube Beat Loaded & Ready";
    }
}

    // --- 2. AUDIO ENGINE (VOLUME FIX) ---
    async function initAudioEngine() {
        await Tone.start();
        if (!masterGain) {
            masterGain = new Tone.Gain(1.5).toDestination(); 
            limiter = new Tone.Limiter(-1).connect(masterGain); 
            streamDestination = Tone.context.createMediaStreamDestination();
            masterGain.connect(streamDestination);
            recorder = new Tone.Recorder();
            masterGain.connect(recorder);
        }
    }

    document.getElementById('beatInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(file){
            await initAudioEngine();
            useYouTube = false;
            const url = URL.createObjectURL(file);
            if(beatPlayer) beatPlayer.dispose();
            beatPlayer = new Tone.Player(url).connect(limiter);
            document.getElementById('file-label').innerText = "‚úÖ " + file.name;
        }
    });

    // --- 3. RECORDING ---
    async function toggleRecording() {
        const btn = document.getElementById('btnRecord');
        if (!isRecording) {
        await initAudioEngine();
        if (!mic) {
            mic = new Tone.UserMedia();
            await mic.open();
            mic.connect(limiter);
        }
        
        recorder.start();

        if(useYouTube) {
            player.seekTo(0); // Move YouTube to the start
            player.playVideo();
        } else if(beatPlayer) {
            beatPlayer.start(0, 0); // Start File Player from 0 seconds
        }

        isRecording = true;
        btn.innerText = "‚ñ† STOP RECORDING";
        btn.classList.add('recording');
    } else {
            const rawBlob = await recorder.stop();
            audioBlob = await convertToWav(rawBlob);
            
            const url = URL.createObjectURL(audioBlob);
            const audioEl = document.getElementById('masterAudio');
            audioEl.src = url;
            audioEl.style.display = 'block';
            document.getElementById('downloadGroup').style.display = 'flex';
            
            if(useYouTube) player.pauseVideo();
            else if(beatPlayer) beatPlayer.stop();
            isRecording = false;
            btn.innerText = "‚óè RECORD NEW TAKE";
            btn.classList.remove('recording');
        }
    }

    function updateMix() {
        const b = document.getElementById('beatSlider').value;
        const v = document.getElementById('voiceSlider').value;
        if(beatPlayer) beatPlayer.volume.value = Tone.gainToDb(b);
        if(mic) mic.volume.value = Tone.gainToDb(v);
        if(useYouTube && player) player.setVolume(b * 100);
    }

    // --- 4. iOS DOWNLOAD / SHARE FIX ---
    async function shareAudio() {
        if (!audioBlob) return;
        const file = new File([audioBlob], "VibeStream_Recording.wav", { type: "audio/wav" });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'My VibeStream Recording',
                });
            } catch (err) { console.error("Share failed", err); }
        } else {
            // Fallback for browsers without Share API
            const a = document.createElement('a');
            a.href = URL.createObjectURL(audioBlob);
            a.download = "VibeStream_Recording.wav";
            a.click();
        }
    }

    // --- 5. VIDEO LOGIC ---
    let videoRec, animationId;
    let videoEl = document.createElement('video');
    videoEl.muted = true; videoEl.playsInline = true;

    async function openVideoBooth() {
        document.getElementById('videoModal').style.display = 'flex';
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "user", width: 720, height: 1280 } 
        });
        videoEl.srcObject = stream;
        await videoEl.play();

        function render() {
            ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "rgba(255,255,255,0.5)";
            ctx.font = "bold 40px sans-serif";
            ctx.fillText("VibeStream", 40, canvas.height - 60);
            animationId = requestAnimationFrame(render);
        }
        render();
    }

    async function startVideoRecording() {
        const btn = document.getElementById('btnCamRecord');
        const audioEl = document.getElementById('masterAudio');
        const canvas = document.getElementById('videoCanvas');

        if(btn.innerText.includes("RECORD")) {
            audioEl.currentTime = 0;
            audioEl.play();

            const videoStream = canvas.captureStream(30);
            const audioTrack = streamDestination.stream.getAudioTracks()[0];
            if(audioTrack) videoStream.addTrack(audioTrack);

            videoRec = new MediaRecorder(videoStream, { mimeType: 'video/webm' });
            let chunks = [];
            videoRec.ondataavailable = e => chunks.push(e.data);
            videoRec.onstop = () => {
    const blob = new Blob(chunks, { type: 'video/mp4' });
    const url = URL.createObjectURL(blob);
    const fileName = "VibeStream_Video.mp4";

    // 1. For iPhone/Android: Try the Share Sheet
    if (navigator.share && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        const file = new File([blob], fileName, { type: "video/mp4" });
        navigator.share({ files: [file], title: 'My VibeStream Video' }).catch(() => {
            // Fallback if share is cancelled
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
        });
    } else {
        // 2. For PC/Laptop: Direct hidden link trigger
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        // Clean up
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
    }
    btn.innerText = "‚óè RECORD VIDEO";
};
            videoRec.start();
            btn.innerText = "STOP VIDEO";
        } else {
            videoRec.stop();
            audioEl.pause();
        };
            
    }

    function closeVideoBooth() {
        document.getElementById('videoModal').style.display = 'none';
        cancelAnimationFrame(animationId);
        if(videoEl.srcObject) videoEl.srcObject.getTracks().forEach(t => t.stop());
    }

    // --- WAV ENGINE ---
    async function convertToWav(webmBlob) {
        const arrayBuffer = await webmBlob.arrayBuffer();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        const numOfChan = audioBuffer.numberOfChannels;
        const length = audioBuffer.length * numOfChan * 2 + 44;
        const buffer = new ArrayBuffer(length);
        const view = new DataView(buffer);
        const writeString = (v, o, s) => { for (let i = 0; i < s.length; i++) v.setUint8(o + i, s.charCodeAt(i)); };
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + audioBuffer.length * numOfChan * 2, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numOfChan, true);
        view.setUint32(24, audioBuffer.sampleRate, true);
        view.setUint32(28, audioBuffer.sampleRate * 2 * numOfChan, true);
        view.setUint16(32, numOfChan * 2, true);
        view.setUint16(34, 16, true);
        writeString(view, 36, 'data');
        view.setUint32(40, audioBuffer.length * numOfChan * 2, true);
        let offset = 44;
        for(let pos = 0; pos < audioBuffer.length; pos++){
            for(let i = 0; i < numOfChan; i++){
                let sample = Math.max(-1, Math.min(1, audioBuffer.getChannelData(i)[pos]));
                sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767)|0;
                view.setInt16(offset, sample, true);
                offset += 2;
            }
        }
        return new Blob([buffer], { type: "audio/wav" });
    }
</script>
</body>
</html>
